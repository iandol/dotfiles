#!/usr/bin/env zsh
# This script converts the BibTeX auto-generated by Bookends and makes JSON
# that is more easily consumed by Pandoc

if [[ $# -eq 0 ]]; then
	[[ -d $HOME/Dropbox ]] && dn=$HOME/Dropbox/References
	[[ -d $HOME/Library/CloudStorage/Dropbox ]] && dn=$HOME/Library/CloudStorage/Dropbox/References
	[[ -f "ðŸŒŠCore.bib" ]] && mv ðŸŒŠCore.bib Core.bib
	filename="Core.bib"
else
	dn=$(dirname $1)
	filename=$(basename $1)
fi
cd $dn
mydir=$(pwd)
printf "\n\n======================================@$(date)\n"
printf "---> Processing Bibliography file $filename in $mydir\n"
if [[ ! -s $filename ]]; then # make sure file exists
	printf "\n There was no file $filename\n"
else
	printf '---> Citeproc generating JSON from BIB file...\n' 
	pandoc --verbose -f bibtex -t csljson $filename > Core.json
	if [[ ! -s Temp.json ]]; then
		printf "\tPandoc failed with $filename\n"
		return -1
	fi
fi
if [[ -s Core.json ]]; then
	printf '---> Minifying JSON...\n'
	jq -Sc '. | del(.[]."abstract",.[]."keyword",.[]."publisher-place")' < Core.json > Temp.json
else
	printf '---> ERROR: Core.json does not exist or is empty\n'
fi
[[ -s Temp.json ]] && mv Temp.json Core.json
printf '---> Processing title case...\n'
/Users/ian/bin/fixCase.rb Core.json
printf "---> Finshed processing title case...\n"
printf '===>>> ...Finished!\n'
#!/usr/bin/env zsh
# This script converts the BibTeX auto-generated by Bookends and makes JSON
# that is more easily consumed by Pandoc

[[ -f /opt/homebrew/bin/pandoc ]] && pd=/opt/homebrew/bin/pandoc || pd=/usr/local/bin/pandoc
if [[ $# -eq 0 ]]; then
	[[ -d $HOME/Dropbox ]] && dn=$HOME/Dropbox/Papers/References
	[[ -d $HOME/Library/CloudStorage/Dropbox ]] && dn=$HOME/Library/CloudStorage/Dropbox/Papers/References
	[[ -f "ðŸŒŠCore.bib" ]] && mv ðŸŒŠCore.bib Core.bib
	filename="Core.bib"
else
	dn=$(dirname $1)
	filename=$(basename $1)
fi
cd $dn
mydir=$(pwd)
printf "\n\n======================================@$(date)\n"
printf "---> Processing Bibliography file $filename in $mydir\n"
if [[ ! -s $filename ]]; then # make sure file exists
	printf "\nCannot find $filename\n"
	return -1
fi
printf '---> Citeproc generating JSON from BIB file...\n' 
pandoc --verbose -f bibtex -t csljson $filename > Temp.json
if [[ ! -s Temp.json ]]; then
	printf "\tPandoc failed with $filename\n"
	return -1
fi
printf '---> Processing title case...\n'
/Users/ian/bin/fixCase.rb Temp.json
printf "---> Finshed processing title case...\n"
if [[ -s Temp.json ]]; then
	printf '---> Minifying JSON...\n'
	jq -Sc '. | del(.[]."abstract",.[]."keyword",.[]."publisher-place")' < Temp.json > Core.json
else
	printf '---> ERROR: Temp.json does not exist or is empty\n'
fi
[[ -s Temp.json ]] && rm Temp.json
printf '===>>> ...Finished!\n'
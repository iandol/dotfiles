#!/usr/bin/env zsh
set -euo pipefail

# ===== CONFIG (edit as needed) =====
DEST_USER_HOST="cagelab@cagelab-dev.cloud.lab"  # remote SSH user@host
DEST_BASE="~/Code"                              # remote base dir; ~ expands on remote
EXCLUDES="${HOME}/.config/.rsync-excludes"      # optional common exclude list

# SSH options for robustness & non-interactive automation
SSH_OPTS=(
  -o BatchMode=yes
  -o ConnectTimeout=10
  -o ServerAliveInterval=30
  -o ServerAliveCountMax=3
)

# Base rsync flags (archive, compress, mirror, human output, progress & stats)
RSYNC_FLAGS=(
  -a -z --delete
  --human-readable
  --itemize-changes
  --info=stats2,progress2
  --partial --partial-dir=.rsync-partial
)

# Uncomment if you need these across Linux↔Linux with matching filesystems:
# RSYNC_FLAGS+=(-H -A -X)   # hardlinks, ACLs, xattrs

# Optional bandwidth cap (KB/s): e.g., 20000 ≈ 20 MB/s
# RSYNC_FLAGS+=(--bwlimit=20000)

# ===== ARGUMENTS =====
# Usage:
#   cagepush [-n] <src_dir1> [src_dir2 ...]
# If no sources are given, default to ~/Code/CageLab.
DRYRUN=0
sources=()

# Parse a very small option set: -n / --dry-run
for arg in "$@"; do
  case "$arg" in
    -n|--dry-run) DRYRUN=1 ;;
    --) shift; break ;;
    -*) echo "Unknown option: $arg" >&2; exit 2 ;;
    *) sources+=("$arg") ;;
  esac
done

# If nothing was added after options, default to one project
if [[ ${#sources} -eq 0 ]]; then
  sources=("${HOME}/Code/CageLab")
fi

# Add exclude list if present
[[ -f "${EXCLUDES}" ]] && RSYNC_FLAGS+=("--exclude-from=${EXCLUDES}")

# Dry run requested?
(( DRYRUN )) && RSYNC_FLAGS+=("--dry-run")

# ===== FEATURE DETECTION: --mkpath =====
HAS_MKPATH=0
if rsync --help 2>&1 | grep -q -- '--mkpath'; then
  HAS_MKPATH=1
  RSYNC_FLAGS+=("--mkpath")
fi

# ===== FUNCTIONS =====
sync_one() {
  local src_raw="$1"
  # Resolve to absolute path locally; ensure trailing slash to copy *contents*
  local src_abs="${src_raw:A}"
  if [[ ! -d "$src_abs" ]]; then
    echo "Skipping: $src_abs (not a directory)" >&2
    return 1
  fi
  local src_with_slash="${src_abs%/}/"

  # Destination path: DEST_BASE/<basename(src)>/
  local base_name
  base_name="$(basename "$src_abs")"
  local dest_path="${DEST_BASE%/}/${base_name}/"  # keep trailing slash

  # Create destination path if mkpath isn't available
  if (( ! HAS_MKPATH )); then
    # Quote to keep ~ for remote expansion; do NOT expand locally
    ssh "${SSH_OPTS[@]}" "${DEST_USER_HOST}" "mkdir -p '${dest_path%/}'" >/dev/null
  fi

  echo "→ Syncing: ${src_with_slash}  ➜  ${DEST_USER_HOST}:${dest_path}"
  rsync "${RSYNC_FLAGS[@]}" \
    -e "ssh ${SSH_OPTS[*]}" \
    -- \
    "${src_with_slash}" "${DEST_USER_HOST}:${dest_path}"
}

# ===== RUN (iterate all sources) =====
rc=0
for s in "${sources[@]}"; do
  if ! sync_one "$s"; then
    rc=1
  fi
done
exit "$rc"
